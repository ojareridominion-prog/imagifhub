<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IMAGIFHUB</title>
    <script src="https://unpkg.com/@telegram-apps/sdk@7.2.0/dist/core.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <style>
        :root { --bg: #000; --text: #fff; --bar: #1a1a1a; --accent: #9c4dff; }
        /* Premium Themes */
        .theme-white { --bg: #fff; --text: #000; --bar: #f0f0f0; }
        .theme-blood { --bg: #4a0e0e; --text: #ffcfcf; --bar: #2a0505; --accent: #ff4d4d; }
        .theme-neon { --bg: #000; --text: #0ff; --bar: #001a1a; --accent: #0ff; }
        .theme-sunset { --bg: #2d142c; --text: #feb47b; --bar: #1a0a19; --accent: #ff7e5f; }
        .theme-forest { --bg: #0b1a10; --text: #d4f1d5; --bar: #050d08; --accent: #4caf50; }
        .theme-amethyst { --bg: #1a0b2e; --text: #e0d4f1; --bar: #0d051a; --accent: #9c4dff; }

        body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui; overflow:hidden; transition: 0.3s; }
        .top-bar { position:fixed; top:0; width:100%; height:56px; background:var(--bar); display:flex; align-items:center; z-index:100; border-bottom:1px solid rgba(255,255,255,0.1); }
        .cat-bar { position:fixed; top:56px; width:100%; height:48px; background:var(--bar); overflow-x:auto; display:flex; align-items:center; gap:10px; padding:0 12px; z-index:90; }
        .cat-btn { padding:6px 15px; border-radius:20px; background:#333; font-size:12px; white-space:nowrap; cursor:pointer; }
        .cat-btn.active { background:var(--accent); color:#fff; }
        
        /* Menu Styling */
        .menu-panel { position:fixed; left:-100%; width:85%; height:100%; background:var(--bar); z-index:200; transition:0.4s; padding-top:60px; box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
        .menu-panel.open { left:0; }
        .menu-link { padding:15px 25px; border-bottom:1px solid rgba(255,255,255,0.05); display:block; text-decoration:none; color:var(--text); font-weight:500; }
        
        /* Theme Row */
        .theme-row { display:flex; overflow-x:auto; padding:15px; gap:15px; }
        .theme-circle { width:45px; height:45px; border-radius:50%; border:2px solid #444; position:relative; overflow:hidden; transform:rotate(-45deg); flex-shrink:0; }
        .half-p { width:50%; height:100%; position:absolute; left:0; }
        .half-s { width:50%; height:100%; position:absolute; right:0; }

        #swiper { position:absolute; top:104px; bottom:0; width:100%; }
        .swiper-slide img { width:100%; height:100%; object-fit:cover; }
        .meta-overlay { position:absolute; bottom:40px; left:15px; text-shadow: 2px 2px 5px #000; }
    </style>
</head>
<body>
    <div class="top-bar">
        <button onclick="toggleMenu()" style="background:none; border:none; color:#fff; font-size:24px; padding:15px;">‚ò∞</button>
        <h2 style="flex:1; text-align:center; font-size:16px; letter-spacing:1px;">IMAGIFHUB</h2>
        <button onclick="triggerSearch()" style="background:none; border:none; color:#fff; font-size:20px; padding:15px;">üîç</button>
    </div>

    <div class="cat-bar" id="catBar"></div>

    <div id="menuPanel" class="menu-panel">
        <a href="#" class="menu-link" onclick="toggleMenu()" style="color:var(--accent)">‚úï Close Menu</a>
        <a href="playlist.html" class="menu-link">üìÇ My Playlist</a>
        <a href="https://t.me/imagifhub" class="menu-link">üì¢ Official Channel</a> <a href="premium.html" class="menu-link" style="color:gold;">‚≠ê Premium Subscription</a>
        
        <div style="padding:15px 25px 0; font-size:12px; opacity:0.6;">SELECT THEME</div>
        <div class="theme-row" id="themeBar"></div>
    </div>

    <div id="swiper" class="swiper"><div class="swiper-wrapper" id="feed"></div></div>
    <audio id="bgMusic" loop></audio>

    <script>
             /* TELEGRAM INIT */
Telegram.WebApp.ready();
Telegram.WebApp.expand();

/* CONFIG - CHANGE THIS TO YOUR RENDER URL */
const API_URL = "https://your-app-name.onrender.com"; 

/* DATA & STATE */
const categories = ["All", "Nature", "Space", "City", "Superhero", "Anime", "Cars", "Luxury", "Gaming"];
const categoryMusic = {
  Nature: ["https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"],
  Anime: ["https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3"],
  Cars: ["https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3"],
  Default: ["https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3"]
};

let currentCat = "All";
let musicPlaying = false;
const audio = document.getElementById("bgMusic");

/* 1. BUILD CATEGORY BAR */
function buildCategoryBar() {
  const bar = document.getElementById("catBar");
  bar.innerHTML = "";
  categories.forEach(c => {
    const b = document.createElement("div");
    b.className = "cat-btn" + (c === currentCat ? " active" : "");
    b.textContent = c;
    b.onclick = () => { 
      currentCat = c; 
      buildCategoryBar(); 
      loadFeed(c); 
    };
    bar.appendChild(b);
  });
}

/* 2. DYNAMIC FEED LOADER (SUPABASE) */
async function loadFeed(cat) {
  const feed = document.getElementById("feed");
  
  // Show Loading State
  feed.innerHTML = '<div class="swiper-slide"><h3>Randomizing Feed...</h3></div>';

  try {
    // Fetch real data from your FastAPI/Supabase backend
    const response = await fetch(`${API_URL}/media?category=${cat.toLowerCase()}`);
    const data = await response.json();

    if (!data || data.length === 0) {
      feed.innerHTML = '<div class="swiper-slide"><h3>No images found in this category.</h3></div>';
      return;
    }

    // Map Supabase data to Swiper slides
    feed.innerHTML = data.map(item => `
      <div class="swiper-slide">
        <img src="${item.url}" alt="Wallpaper">
        <div class="keyword-title">#${item.Keyword || item.category}</div>
      </div>
    `).join('');

    // Re-initialize Swiper for vertical scrolling
    if (document.getElementById("swiper").swiper) {
      document.getElementById("swiper").swiper.destroy(true, true);
    }
    new Swiper("#swiper", { 
      direction: "vertical", 
      mousewheel: true 
    });

    // Update Music for Category
    playMusic();

  } catch (error) {
    console.error("Fetch error:", error);
    feed.innerHTML = '<div class="swiper-slide"><h3>Backend Connection Error</h3></div>';
  }
}

/* 3. MENU CONTROLS */
function toggleMenu() {
  document.getElementById("menuPanel").classList.toggle("open");
}

/* 4. MUSIC LOGIC */
function playMusic() {
  const key = currentCat in categoryMusic ? currentCat : "Default";
  const list = categoryMusic[key];
  audio.src = list[Math.floor(Math.random() * list.length)];
  audio.volume = 0.5;
  audio.play().then(() => {
    musicPlaying = true;
    document.getElementById("musicBtn").textContent = "‚ùö‚ùö";
  }).catch(() => {
    console.log("Music blocked by browser; waiting for user click.");
  });
}

function toggleMusic() {
  if (musicPlaying) {
    audio.pause();
    musicPlaying = false;
    document.getElementById("musicBtn").textContent = "‚ô™";
  } else {
    playMusic();
  }
}

/* 5. TELEGRAM TRIGGERS */
Telegram.WebApp.onEvent("viewportChanged", () => {
  if (!musicPlaying) playMusic();
});

/* INITIALIZE APP */
buildCategoryBar();
loadFeed("All");
    
    </script>
</body>
</html>
