<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>IMAGIFHUB</title>
  <script src="https://unpkg.com/@telegram-apps/sdk@7.2.0/dist/core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" rel="stylesheet"/>
  <style>
    :root {
      --bg: #000; --text: #fff; --accent: #9c4dff; --bar: #111;
    }
    [data-theme="white"] {--bg:#f9f9f9; --text:#000; --bar:#fff;}
    [data-theme="red"] {--accent:#ff3333;}
    [data-theme="green"] {--accent:#00ff7f;}
    [data-theme="darkblue"] {--accent:#1e3a8a;}
    [data-theme="skyblue"] {--accent:#0ea5e9;}
    [data-theme="grey"] {--accent:#6b7280;}
    [data-theme="purple"] {--accent:#8b5cf6;}
    [data-theme="pink"] {--accent:#ec4899;}
    [data-theme="orange"] {--accent:#f97316;}
    [data-theme="smoke"] {--accent:#9ca3af;}
    [data-theme="brightyellow"] {--accent:#eab308;}
    [data-theme="paleyellow"] {--accent:#fef3c7;}
    body,html,#app{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui;overflow:hidden;}
    .bar{position:fixed;top:0;left:0;right:0;height:56px;background:var(--bar);z-index:1000;display:flex;align-items:center;padding:0 12px;box-sizing:border-box;gap:8px;border-bottom:1px solid #333;}
    .btn{background:var(--accent);color:#fff;padding:8px 14px;border-radius:8px;font-size:14px;font-weight:600;border:none;cursor:pointer;}
    .cat-bar{position:fixed;top:56px;left:0;right:0;height:48px;background:var(--bar);overflow-x:auto;white-space:nowrap;padding:8px 12px;box-sizing:border-box;z-index:999;border-bottom:1px solid #333;}
    .cat-btn{display:inline-block;padding:8px 16px;background:#333;border-radius:20px;margin-right:8px;font-size:14px;border:none;cursor:pointer;}
    .cat-btn.active{background:var(--accent);}
    .swiper{width:100%;height:100%;padding-top:104px !important;}
    .slide{display:flex;align-items:center;justify-content:center;background:#000;position:relative;}
    img,video{max-width:100%;max-height:100%;object-fit:contain;}
    .bottom-bar{position:fixed;bottom:0;left:0;right:0;height:70px;background:var(--bar);display:flex;align-items:center;justify-content:space-around;z-index:1000;border-top:1px solid #333;}
    .icon{font-size:28px;cursor:pointer;}
    .search-bar{position:fixed;top:104px;left:0;right:0;background:var(--bar);padding:8px 12px;z-index:998;}
    .search-input{background:#333;color:var(--text);border:none;border-radius:8px;padding:8px;width:100%;box-sizing:border-box;}
    .premium-btn{position:fixed;top:10px;right:10px;z-index:1001;}
    .music-btn{position:fixed;top:10px;left:10px;z-index:1001;background:var(--accent);color:#fff;padding:6px 10px;border-radius:50%;font-size:20px;}
  </style>
</head>
<body data-theme="dark">
  <div id="app">
    <!-- Music Button -->
    <button class="music-btn" onclick="toggleMusic()">‚ô™</button>

    <!-- Premium Button -->
    <button class="btn premium-btn" onclick="goPremium()">Go Premium ($5/mo)</button>

    <!-- Top Bar -->
    <div class="bar">
      <button class="btn" onclick="Telegram.WebApp.openTelegramLink('https://t.me/imagifhub')">Channel</button>
      <button class="btn" onclick="shareBot()">Share</button>
      <button class="btn active" id="allBtn">All</button>
      <button class="btn" id="imgBtn">Images</button>
      <button class="btn" id="gifBtn">GIFs</button>
    </div>

    <!-- Search Bar -->
    <div class="search-bar">
      <input type="text" class="search-input" id="searchInput" placeholder="Search keywords..." oninput="searchTerm = this.value; loadFeed(currentCat, currentType, this.value)">
    </div>

    <!-- Category Bar -->
    <div class="cat-bar" id="catBar"></div>

    <!-- Swiper Feed -->
    <div class="swiper" id="swiper">
      <div class="swiper-wrapper" id="feed"></div>
    </div>

    <!-- Bottom Bar -->
    <div class="bottom-bar">
      <span class="icon" onclick="likeCurrent()">‚ù§Ô∏è <span id="likeCount">0</span></span>
      <span class="icon" onclick="saveCurrent()">üíæ Save</span>
      <span class="icon" onclick="shareCurrent()">üì§ Share</span>
      <span class="icon" onclick="openPlaylist()">üìã Playlist</span>
    </div>
  </div>

<!-- Background Music -->
<audio id="bgMusic" loop>
  <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
</audio>

<script>
  const API_BASE = "https://imagifhub.onrender.com";
  let currentMedia = [], currentIndex = 0, currentCat = "all", currentType = "all", searchTerm = "";
  let isPremium = localStorage.getItem("premium") === "true" || false;
  let savesToday = parseInt(localStorage.getItem("savesToday") || "0");
  let playlist = JSON.parse(localStorage.getItem("playlist") || "[]");
  let musicPlaying = false;

  // BACKGROUND MUSIC TRACKS (FREE FOR ALL USERS)
  const musicTracks = [
    "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3",   // Chill lo-fi
    "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3",   // Upbeat
    "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3",   // Calm
    // ADD MORE HERE ‚Äî just paste direct MP3 links (free royalty-free from soundhelix or pixabay)
    // Example: "https://pixabay.com/music/link-to-mp3"
  ];
  let currentTrack = 0;
  const audio = document.getElementById("bgMusic");

  function toggleMusic() {
    if (musicPlaying) {
      audio.pause();
      musicPlaying = false;
    } else {
      audio.src = musicTracks[currentTrack];
      audio.play();
      musicPlaying = true;
    }
  }

  // Premium users can change track
  function nextTrack() {
    if (!isPremium) return Telegram.WebApp.showAlert("Premium feature!");
    currentTrack = (currentTrack + 1) % musicTracks.length;
    audio.src = musicTracks[currentTrack];
    audio.play();
  }

  // TO ADD/REMOVE MUSIC: Edit the musicTracks array above
  // Find free royalty-free MP3s on:
  // - https://soundhelix.com
  // - https://pixabay.com/music
  // - https://freesound.org
  // Just copy the direct .mp3 link and add to the array

  const categories = ["All","Nature","Space","City","Superhero","Supervillain","Robotic","Anime","Cars","Wildlife","Funny","Seasonal Greetings","Dark Aesthetic","Luxury","Gaming","Ancient World"];

  Telegram.WebApp.ready();
  Telegram.WebApp.expand();

  // Category bar
  const catBar = document.getElementById("catBar");
  categories.forEach(cat => {
    const btn = document.createElement("button");
    btn.className = "cat-btn" + (cat === "All" ? " active" : "");
    btn.textContent = cat;
    btn.onclick = () => {
      document.querySelectorAll(".cat-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentCat = cat === "All" ? "all" : cat;
      loadFeed(currentCat, currentType, searchTerm);
    };
    catBar.appendChild(btn);
  });

  // Type buttons
  document.getElementById("allBtn").onclick = () => { currentType = "all"; loadFeed(); };
  document.getElementById("imgBtn").onclick = () => { currentType = "image"; loadFeed(); };
  document.getElementById("gifBtn").onclick = () => { currentType = "gif"; loadFeed(); };

  async function loadFeed() {
    const params = new URLSearchParams({category: currentCat, type: currentType});
    if (searchTerm) params.append("search", searchTerm);
    const res = await fetch(`\( {API_BASE}/media? \){params}`);
    currentMedia = await res.json();
    renderFeed();
  }

  function renderFeed() {
    const wrapper = document.getElementById("feed");
    wrapper.innerHTML = "";
    currentMedia.forEach(m => {
      const slide = document.createElement("div");
      slide.className = "swiper-slide slide";
      slide.dataset.id = m.id;
      const elem = m.type === "image" ? document.createElement("img") : document.createElement("video");
      elem.src = m.url;
      elem.loading = "lazy";
      if (m.type === "gif") {
        elem.autoplay = elem.loop = elem.muted = elem.playsInline = true;
      }
      slide.appendChild(elem);
      wrapper.appendChild(slide);
    });
    new Swiper("#swiper", {
      direction: "vertical",
      mousewheel: true,
      on: { slideChange: () => updateLikeCount() }
    });
  }

  async function likeCurrent() {
    const id = document.querySelector(".swiper-slide-active")?.dataset.id;
    if (id) {
      await fetch(`\( {API_BASE}/like/ \){id}`, {method: "POST"});
      const media = currentMedia.find(x => x.id == id);
      if (media) media.likes++;
      updateLikeCount();
    }
  }

  function updateLikeCount() {
    const id = document.querySelector(".swiper-slide-active")?.dataset.id;
    const media = currentMedia.find(x => x.id == id);
    document.getElementById("likeCount").textContent = media?.likes || 0;
  }

  function saveCurrent() {
    if (!isPremium && savesToday >= 5) {
      Telegram.WebApp.showAlert("Free users: 5 saves/day. Go premium for unlimited!");
      return;
    }
    const url = document.querySelector(".swiper-slide-active img, .swiper-slide-active video")?.src;
    playlist.push(url);
    localStorage.setItem("playlist", JSON.stringify(playlist));
    savesToday++;
    localStorage.setItem("savesToday", savesToday);
    Telegram.WebApp.showAlert("Saved!");
  }

  function shareCurrent() {
    const url = document.querySelector(".swiper-slide-active img, .swiper-slide-active video")?.src;
    Telegram.WebApp.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=From @IMAGIFHUB`);
  }

  function shareBot() {
    Telegram.WebApp.openTelegramLink('https://t.me/share/url?url=https://t.me/IMAGIFHUB&text=Check out IMAGIFHUB ‚Äî endless images & GIFs!');
  }

  function openPlaylist() {
    Telegram.WebApp.showAlert(`Playlist (${playlist.length} items saved)`);
  }

  function goPremium() {
    Telegram.WebApp.showPopup({
      title: "Go Premium",
      message: "Unlimited saves, more themes, no ads, exclusive music ‚Äî $5/month",
      buttons: [{text: "Buy with Stars", type: "default"}, {text: "Cancel", type: "cancel"}]
    });
  }

  // Double tap like
  document.querySelector(".swiper").addEventListener("dblclick", likeCurrent);

  // Start music on first interaction (Telegram rule)
  document.body.addEventListener("touchstart", () => {
    if (!musicPlaying) toggleMusic();
  }, {once: true});

  loadFeed();
</script>
</body>
</html>
